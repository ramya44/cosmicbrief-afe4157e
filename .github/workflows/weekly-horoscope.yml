name: Weekly Horoscope Email

on:
  schedule:
    # Every Monday at 8am EST (1pm UTC)
    - cron: '0 13 * * 1'
  workflow_dispatch:
    # Allow manual trigger for testing
    inputs:
      test_email:
        description: 'Test email (leave empty to send to all subscribers)'
        required: false
        type: string

jobs:
  send-weekly-horoscope:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger weekly horoscope emails
        run: |
          # Build the request body
          if [ -n "${{ inputs.test_email }}" ]; then
            BODY='{"test_mode": true, "test_email": "${{ inputs.test_email }}"}'
          else
            BODY='{}'
          fi

          # Call the Supabase edge function
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/send-weekly-horoscope" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          # Extract response body (all but last line)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"

          # Fail if not 200
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Edge function returned $HTTP_CODE"
            exit 1
          fi

          echo "Weekly horoscope emails sent successfully!"
